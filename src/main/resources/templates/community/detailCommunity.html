<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/default_form}">
<th:block layout:fragment="head">
    <title>커뮤니티 게시글 보기</title>
    <meta charset="utf-8">

    <!-- css -->
    <link th:href="@{/css/layout_content.css}" rel="stylesheet"/>

    <!-- Bootstrap CSS -->
    <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
            rel="stylesheet"
            integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3"
            crossorigin="anonymous">

    <script
            src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
            crossorigin="anonymous">

    </script>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css">
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.13.1/css/bootstrap-select.css"/>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.13.1/js/bootstrap-select.min.js"></script>
    <script type="text/javascript" src="http://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://code.jquery.com/jquery-1.12.4.min.js"></script>
    <script src="http://ajax.aspnetcdn.com/ajax/jQuery/jquery-1.12.4.min.js"></script>
</th:block>
<head>
    <script type="text/javascript" th:inline="javascript">
        const main ={
            init:function(){
                $(document).on('click', '#btn-comment-save', () => {
                    this.commentSave();
                });
            },

            commentSave : function(){
                const communityId = $("#communityId").val();
                const reqDto = {
                    commentContent : $('#commentContent').val(),
                    parentId : $('#parentId').val()
                }

                if(!reqDto.commentContent || reqDto.commentContent.trim() === ""){
                    alert("공백 또는 입력하지 않은 부분이 있습니다.");
                    return false;
                }
                else {
                    $.ajax({
                        type: "POST",
                        url:'/communityComment/'+communityId+'/createComment',
                        contentType:'application/json; charset=utf-8',
                        data: JSON.stringify(reqDto)
                    }).done(function(){
                        alert('댓글이 등록되었습니다.');
                        window.location.reload();
                    }).fail(function (error){
                        alert(JSON.stringify(error));
                    });
                }
            }
        };
        main.init();

        const main2 ={
            init:function(){
                $("#btn-comment-save2").off('click').on('click', () => {
                    this.commentSave();
                });
            },

            commentSave : function(parentId){
                const communityId = $("#communityId").val();
                const reqDto = {
                    commentContent : $('#commentContent2'+parentId).val(),
                    parentId : parentId
                }

                if(!reqDto.commentContent || reqDto.commentContent.trim() === ""){
                    alert("공백 또는 입력하지 않은 부분이 있습니다.");
                    return false;
                }
                else {
                    $.ajax({
                        type: "POST",
                        url:'/communityComment/'+communityId+'/createComment',
                        contentType:'application/json; charset=utf-8',
                        data: JSON.stringify(reqDto)
                    }).done(function(){
                        alert('대댓글이 등록되었습니다.');
                        window.location.reload();
                    }).fail(function (error){
                        alert(JSON.stringify(error));
                    });
                }
            }
        };
        main2.init();

        const main3 ={
            init:function(){
                $("#deleteCommentBtn").off('click').on('click', () => {
                    this.commentDelete();
                });
            },

            commentDelete : function(commentId, communityId) {
                const d_check = confirm("삭제하시겠습니까?");
                if (d_check === true) {
                    $.ajax({
                        type: "GET",
                        url: '/communityComment/deleteComment/' + commentId + '/' + communityId
                    }).done(function () {
                        alert('댓글이 삭제되었습니다.');
                        window.location.reload();
                    }).fail(function (error) {
                        alert(JSON.stringify(error));
                    });
                }
            }
        };
        main3.init();

        const main4 = {
            init: function () {
                $("#deleteReCommentBtn").off('click').on('click', () => {
                    this.commentDelete();
                });
            },

            commentDelete: function (commentId, communityId) {
                const d_check = confirm("삭제하시겠습니까?");
                if (d_check === true) {
                    $.ajax({
                        type: "GET",
                        url: '/communityComment/deleteComment/' + commentId + '/' + communityId
                    }).done(function () {
                        alert('대댓글이 삭제되었습니다.');
                        window.location.reload();
                    }).fail(function (error) {
                        alert(JSON.stringify(error));
                    });
                }
            }
        };
        main4.init();

        const main5 ={
            init:function(){
                $("#btn-comment-update").off('click').on('click', () => {
                    this.commentUpdate();
                });
            },

            commentUpdate : function(commentId){
                const communityId = $("#communityId").val();
                const reqDto = {
                    id : commentId,
                    commentContent : $('#updateCommentContent'+commentId).val(),
                }

                if(!reqDto.commentContent || reqDto.commentContent.trim() === ""){
                    alert("공백 또는 입력하지 않은 부분이 있습니다.");
                    return false;
                }
                else {
                    $.ajax({
                        type: "POST",
                        url:'/communityComment/'+communityId+'/updateComment',
                        contentType:'application/json; charset=utf-8',
                        data: JSON.stringify(reqDto)
                    }).done(function(){
                        alert('댓글이 수정되었습니다.');
                        window.location.reload();
                    }).fail(function (error){
                        alert(JSON.stringify(error));
                    });
                }
            }
        };
        main5.init();

        const main6 ={
            init:function(){
                $("#btn-comment-update2").on('click', () => {
                    this.commentUpdate();
                });
            },

            commentUpdate : function(commentId){
                const communityId = $("#communityId").val();
                const reqDto = {
                    id : commentId,
                    commentContent : $('#updateCommentContent2'+commentId).val(),
                }

                if(!reqDto.commentContent || reqDto.commentContent.trim() === ""){
                    alert("공백 또는 입력하지 않은 부분이 있습니다.");
                    return false;
                }
                else {
                    $.ajax({
                        type: "POST",
                        url:'/communityComment/'+communityId+'/updateComment',
                        contentType:'application/json; charset=utf-8',
                        data: JSON.stringify(reqDto)
                    }).done(function(){
                        alert('대댓글이 수정되었습니다.');
                        window.location.reload();
                    }).fail(function (error){
                        alert(JSON.stringify(error));
                    });
                }
            }
        };
        main6.init();

    </script>
    <meta charset="UTF-8">
    <title>커뮤니티 게시글 보기</title>
</head>
<body>
<div layout:fragment="content" class="content">
    <br><br>
    <table style = "margin-left:auto; margin-right: auto;">
        <tr>
            <td>
                <th:block th:if = "${not #strings.isEmpty(communityDto.imgUrl)}"  class="div-img row pt-3">
                    <img style="height: 50%; width: 50%" th:src="@{${communityDto.imgUrl}}" alt="...">
                </th:block>
                <th:block th:unless="${not #strings.isEmpty(communityDto.imgUrl)}" >
                    <img src="/image/curby.png" width="500px" height="300px">
                </th:block>
                <br>
                <th:block>
                    생성시간: <h6 th:text = "${#temporals.format(communityDto.created,'yyyy-dd-MM HH:mm')}"></h6>
                </th:block>
                <th:block>
                    수정시간: <h6 th:text = "${#temporals.format(communityDto.updated,'yyyy-dd-MM HH:mm')}"></h6>
                </th:block>
            </td>
            <td>&nbsp;&nbsp;</td>
            <td>
                <table class ="table table-borderless">
                    <tr th:text = "${postUser.name}"></tr>

                    <tr><h3 th:text="${communityDto.title}"></h3></tr>

                    <tr>
                        <td>작성내용</td>
                        <td th:text = "${communityDto.contentCommunity}"></td>
                    </tr>
                </table>
                <th:block th:if = "${postUser.userId} == ${loginUser.userId}">
                    <a th:href="@{/community/updateCommunity(id=${communityDto.id})}" class="btn btn-primary" role="button">글 수정하기</a>
                    <a th:href="@{/community/deleteCommunity(id=${communityDto.id})}" class="btn btn-danger" role="button">글 삭제하기</a>
                </th:block>
            </td>
        </tr>
    </table>

    <div class="card mb-2 mt-5">

        <div class="card-header bg-light">
            <i class="fa fa-comment fa"></i> 댓글
        </div>
        <form id = "commentForm">
            <div class="card-body">
                <input type="hidden" id="communityId" th:value="${communityDto.id}">
                <input type= "hidden" id="parentId" value = "" >
                <ul class="list-group list-group-flush">
                    <li class="list-group-item">
                        <textarea class="form-control" id = "commentContent" rows="1"></textarea>
                        <button id="btn-comment-save" type="button" class="btn btn-dark mt-3">등록</button>
                    </li>
                </ul>
            </div>
        </form>
    </div>

    <br/>
    <div class="card">
        <ul class="list-group" th:each="communityComment : ${communityComments}">
            <div th:if = "${communityComment.getParent() == null}">
                <li class="list-group-item d-flex justify-content-between">
                    <div class ="d-flex">
                        <span th:text="작성자"></span> &nbsp;<div th:text="${communityComment.getName()}"></div>
                    </div>
                    <div th:text="${communityComment.getCommentContent()}"></div>
                    <br>
                    <div class ="d-flex">
                        <div>
                            <button class="badge badge-primary" type="button" data-bs-toggle="collapse" th:attr = "data-bs-target='#reCommentForm'+${communityComment.getId()}" aria-expanded="false">
                                답글 달기
                            </button><span> | </span>
                        </div>
                        <div th:if="${communityComment.getUser() == loginUser}">
                            <button class="badge badge-warning" type="button" data-bs-toggle="collapse" th:attr = "data-bs-target='#updateCommentForm'+${communityComment.getId()}" aria-expanded="false">
                                수정
                            </button><span> | </span>
                            <button class="badge badge-danger" id="deleteCommentBtn" th:cid = "${communityComment.getId()}" th:pid="${communityComment.getCommunityId()}" th:onclick="main3.commentDelete(this.getAttribute('cid'), this.getAttribute('pid'))">
                                삭제
                            </button><span> | </span>
                        </div>
                        <div th:if="${!communityComment.getChildren().isEmpty()}">
                            <button class="badge badge-primary" type="button" data-bs-toggle="collapse" th:attr = "data-bs-target='#reComment'+${communityComment.getId()}" aria-expanded="false">
                                답글 보기
                            </button>
                        </div>
                    </div>
                </li>
            </div>

            <form th:id = "reCommentForm+${communityComment.getId()}" class="collapse">
                <div class="card-header bg-light">
                    <i class="fa fa-comment fa"></i> 대댓글
                </div>
                <div class="card-body">
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item">
                            <textarea class="form-control" th:id = "commentContent2+${communityComment.getId()}" rows="1"></textarea>
                            <button id="btn-comment-save2" type="button" class="btn btn-dark mt-3" th:parentId = "${communityComment.getId()}" th:onclick="main2.commentSave(this.getAttribute('parentId'))">
                                등록
                            </button>
                        </li>
                    </ul>
                </div>
            </form>

            <form th:id = "updateCommentForm+${communityComment.getId()}" class="collapse">
                <div class="card-header bg-light">
                    <i class="fa fa-comment fa"></i> 댓글 수정
                </div>
                <div class="card-body">
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item">
                            <textarea class="form-control" th:id = "updateCommentContent+${communityComment.getId()}" rows="1" th:text="${communityComment.getCommentContent()}"></textarea>
                            <button id="btn-comment-update" type="button" class="btn btn-dark mt-3" th:commentId = "${communityComment.getId()}" th:onclick="main5.commentUpdate(this.getAttribute('commentId'))">
                                수정
                            </button>
                        </li>
                    </ul>
                </div>
            </form>

            <div th:id = "reComment+${communityComment.getId()}" class="collapse">
                <ul class="list-group" th:each="children : ${communityComment.getChildren()}">
                    <li class="list-group-item d-flex justify-content-between">
                        <img src="/image/reply.png" alt="답글" style="display:inline" width="50px" height="50px" >
                        <div class="d-flex">
                            <span th:text="작성자"></span>&nbsp;<div th:text="${children.getName()}"></div>
                        </div>
                        <div th:text="${children.getCommentContent()}"></div><br/>
                        <div class="d-flex">
                            <div th:if="${children.getUser() == loginUser}">
                                <button class="badge badge-warning" type="button" data-bs-toggle="collapse" th:attr = "data-bs-target='#updateReCommentForm'+${children.getId()}" aria-expanded="false">
                                    수정
                                </button><span> | </span>
                                <button class="badge badge-danger" id="deleteReCommentBtn" th:cid = "${children.getId()}" th:pid="${children.getCommunityId()}" th:onclick="main4.commentDelete(this.getAttribute('cid'), this.getAttribute('pid'))">
                                    삭제
                                </button>
                            </div>
                        </div>
                    </li>

                    <form th:id = "updateReCommentForm+${children.getId()}" class="collapse">
                        <div class="card-header bg-light">
                            <i class="fa fa-comment fa"></i> 대댓글 수정
                        </div>
                        <div class="card-body">
                            <ul class="list-group list-group-flush">
                                <li class="list-group-item">
                                    <textarea class="form-control" th:id = "updateCommentContent2+${children.getId()}" rows="1" th:text="${children.getCommentContent()}"></textarea>
                                    <button id="btn-comment-update2" type="button" class="btn btn-dark mt-3" th:commentId = "${children.getId()}" th:onclick="main6.commentUpdate(this.getAttribute('commentId'))">
                                        수정
                                    </button>
                                </li>
                            </ul>
                        </div>
                    </form>

                </ul>
            </div>
        </ul>
    </div>
</div>
</body>
</html>